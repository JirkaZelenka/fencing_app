{% extends 'base.html' %}

{% block title %}Kalendář akcí - Šermířská aplikace{% endblock %}

{% block content %}
<h1>Kalendář akcí</h1>

<!-- Event Type Filters -->
<div class="card mt-3">
    <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
            <h5 class="mb-0">Filtrovat podle typu akce</h5>
        </div>
        <form method="get" class="event-type-filter-form mt-3">
            <input type="hidden" name="year" value="{{ year }}">
            <input type="hidden" name="month" value="{{ month }}">
            {% if selected_filter_year %}
            <input type="hidden" name="filter_year" value="{{ selected_filter_year }}">
            {% endif %}
            <div class="d-flex flex-wrap gap-3">
                {% for filter in event_type_filters %}
                    <div class="form-check form-check-inline event-filter-chip {{ filter.class_suffix }}">
                        <input class="form-check-input" type="checkbox" name="types" value="{{ filter.value }}" id="filter_{{ filter.value }}" {% if filter.checked %}checked{% endif %} onchange="this.form.submit()">
                        <label class="form-check-label" for="filter_{{ filter.value }}">{{ filter.label }}</label>
                    </div>
                {% endfor %}
            </div>
            <noscript>
                <button type="submit" class="btn btn-primary btn-sm mt-2">Použít filtr</button>
            </noscript>
        </form>
    </div>
</div>

<!-- Calendar View -->
<div class="row mt-4">
    <div class="col-12 col-lg-6 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">{{ month_name }} {{ year }}</h3>
                <div>
                    {% if filter_query or selected_filter_year %}
                    <a href="?year={{ prev_year }}&month={{ prev_month }}{% if filter_query %}&{{ filter_query }}{% endif %}{% if selected_filter_year %}&filter_year={{ selected_filter_year }}{% endif %}" class="btn btn-sm btn-outline-primary me-2">
                        ← Předchozí
                    </a>
                    <a href="?year={{ next_year }}&month={{ next_month }}{% if filter_query %}&{{ filter_query }}{% endif %}{% if selected_filter_year %}&filter_year={{ selected_filter_year }}{% endif %}" class="btn btn-sm btn-outline-primary">
                        Další →
                    </a>
                    {% else %}
                    <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-sm btn-outline-primary me-2">
                        ← Předchozí
                    </a>
                    <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-sm btn-outline-primary">
                        Další →
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="calendar-legend mb-3 d-flex flex-wrap gap-3">
                    {% for filter in event_type_filters %}
                    <div class="d-flex align-items-center">
                        <div class="legend-box event-type {{ filter.class_suffix }} me-2"></div>
                        <small>{{ filter.label }}</small>
                    </div>
                    {% endfor %}
                </div>
                <div class="calendar-grid">
                    <div class="calendar-header">
                        {% for day_name in day_names %}
                            <div class="calendar-day-header">{{ day_name }}</div>
                        {% endfor %}
                    </div>
                    {% for week in calendar_data %}
                        <div class="calendar-week">
                            {% for day_data in week %}
                                {% if day_data %}
                                    <div class="calendar-day {% if day_data.is_today %}today{% endif %} {% if day_data.has_events %}has-events{% endif %}" 
                                         data-date="{{ day_data.date|date:'Y-m-d' }}"
                                         {% if day_data.has_events %}data-bs-toggle="tooltip" data-bs-placement="top" 
                                         title="{% for event in day_data.events %}• [{{ event.type_label }}] {{ event.title }}{% if event.location %} ({{ event.location }}){% endif %}{% if not forloop.last %}&#10;{% endif %}{% endfor %}"{% endif %}>
                                        <div class="day-number">{{ day_data.day }}</div>
                                        {% if day_data.has_events %}
                                            <div class="event-marker-row">
                                                {% for event in day_data.events|slice:":4" %}
                                                    <span class="event-marker {{ event.class_suffix }}"></span>
                                                {% endfor %}
                                                {% if day_data.events|length > 4 %}
                                                    <span class="event-marker more">+{{ day_data.events|length|add:"-4" }}</span>
                                                {% endif %}
                                            </div>
                                            <!-- Hover buttons for events -->
                                            <div class="event-hover-buttons">
                                                {% for event in day_data.events %}
                                                <div class="event-hover-item">
                                                    <div class="event-title-small">{{ event.title }}</div>
                                                    <div class="d-flex gap-1 mt-1">
                                                        <a href="{% url 'statistics_individual' %}?view=club{% if event.event_type == 'tournament' %}&tournament={{ event.title|urlencode }}{% endif %}" class="btn btn-xs btn-outline-primary">Výsledky</a>
                                                        {% if event.has_album %}
                                                            <a href="{% url 'album_detail' event.album_id %}" class="btn btn-xs btn-outline-primary">Fotky</a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="calendar-day empty"></div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Year Filter Buttons -->
{% if available_years %}
<div class="mt-4 mb-3">
    <div class="btn-group" role="group" aria-label="Year filter">
        <a href="?year={{ year }}&month={{ month }}{% if filter_query %}&{{ filter_query }}{% endif %}" 
           class="btn {% if not selected_filter_year %}btn-primary{% else %}btn-outline-primary{% endif %}">
            Vše
        </a>
        {% for event_year in available_years %}
        <a href="?year={{ year }}&month={{ month }}&filter_year={{ event_year }}{% if filter_query %}&{{ filter_query }}{% endif %}" 
           class="btn {% if selected_filter_year == event_year %}btn-primary{% else %}btn-outline-primary{% endif %}">
            {{ event_year }}
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Events List -->
<div class="row mt-4">
    <div class="col-12 col-md-6">
        <h3>Nadcházející akce</h3>
        {% for event in upcoming_events %}
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="card-title mb-0">{{ event.title }}</h5>
                    <span class="badge event-type-badge {{ event.class_suffix }}">{{ event.type_label }}</span>
                </div>
                <p class="card-text">
                    <strong>Datum:</strong>
                    {% if event.has_time %}
                        {{ event.start|date:"d.m.Y H:i" }}
                        {% if event.end %}- {{ event.end|date:"d.m.Y H:i" }}{% endif %}
                    {% else %}
                        {{ event.start|date:"d.m.Y" }}
                    {% endif %}<br>
                    {% if event.location %}<strong>Místo:</strong> {{ event.location }}<br>{% endif %}
                    {% if event.description %}{{ event.description }}<br>{% endif %}
                    {% if event.external_link %}
                        <a href="{{ event.external_link }}" target="_blank" class="btn btn-sm btn-outline-primary">Odkaz na czechfencing</a>
                    {% endif %}
                </p>
                
                <!-- Event Action Buttons -->
                <div class="event-actions mt-3">
                    <a href="{% url 'statistics_individual' %}?view=club{% if event.event_type == 'tournament' %}&tournament={{ event.title|urlencode }}{% endif %}" class="btn btn-sm btn-outline-primary me-2">Výsledky</a>
                    {% if event.has_album %}
                        <a href="{% url 'album_detail' event.album_id %}" class="btn btn-sm btn-outline-primary">Fotky</a>
                    {% endif %}
                </div>
                
                {% if event.allows_reaction %}
                    <form method="post" action="{% url 'event_reaction' event.id %}" class="mt-3">
                        {% csrf_token %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="will_attend" id="will_attend_{{ event.id }}" 
                                   {% if event.user_reaction and event.user_reaction.will_attend %}checked{% endif %}>
                            <label class="form-check-label" for="will_attend_{{ event.id }}">
                                Zúčastním se
                            </label>
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control" name="comment" rows="2" placeholder="Komentář (volitelné)">{% if event.user_reaction %}{{ event.user_reaction.comment }}{% endif %}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm">Uložit reakci</button>
                    </form>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info">
            Zatím žádné nadcházející akce
        </div>
        {% endfor %}
    </div>
    
    <div class="col-12 col-md-6">
        <h3>Minulé akce</h3>
        {% if past_events %}
            {% for event in past_events %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="card-title mb-0">{{ event.title }}</h5>
                        <span class="badge event-type-badge {{ event.class_suffix }}">{{ event.type_label }}</span>
                    </div>
                    <p class="card-text">
                        <strong>Datum:</strong>
                        {% if event.has_time %}
                            {{ event.start|date:"d.m.Y H:i" }}
                            {% if event.end %}- {{ event.end|date:"d.m.Y H:i" }}{% endif %}
                        {% else %}
                            {{ event.start|date:"d.m.Y" }}
                        {% endif %}
                        {% if event.location %}<br><strong>Místo:</strong> {{ event.location }}{% endif %}
                    </p>
                    
                    <!-- Event Action Buttons -->
                    <div class="event-actions mt-3">
                        <a href="{% url 'statistics_individual' %}?view=club{% if event.event_type == 'tournament' %}&tournament={{ event.title|urlencode }}{% endif %}" class="btn btn-sm btn-outline-primary me-2">Výsledky</a>
                        {% if event.has_album %}
                            <a href="{% url 'album_detail' event.album_id %}" class="btn btn-sm btn-outline-primary">Fotky</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                Zatím žádné minulé akce
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .calendar-day {
        position: relative;
    }
    
    .event-hover-buttons {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.5rem;
        z-index: 1000;
        display: none;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        margin-top: 0.25rem;
    }
    
    .calendar-day.has-events:hover .event-hover-buttons {
        display: block;
    }
    
    .event-hover-item {
        padding: 0.25rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .event-hover-item:last-child {
        border-bottom: none;
    }
    
    .event-title-small {
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .btn-xs {
        padding: 0.125rem 0.25rem;
        font-size: 0.7rem;
        line-height: 1.2;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Bootstrap tooltips for calendar days with events
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true
            });
        });
        
        // Add click handler to scroll to events list
        document.querySelectorAll('.calendar-day.has-events').forEach(function(day) {
            day.addEventListener('click', function() {
                var eventsSection = document.querySelector('.row.mt-4');
                if (eventsSection) {
                    eventsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    });
</script>
{% endblock %}

